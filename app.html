<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Earnings Call Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
        }

        select, input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
            min-width: 150px;
        }

        select:focus, input[type="file"]:focus {
            border-color: #667eea;
            outline: none;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin: 0 5px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .action-btn.compare {
            background: linear-gradient(135deg, #27AE60, #2ECC71);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .action-btn.industry {
            background: linear-gradient(135deg, #F39C12, #E67E22);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .action-btn.active {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 30px;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }

        .overall-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .overall-chart {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .overall-chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .overall-chart-wrapper {
            position: relative;
            height: 400px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card p {
            color: #666;
            font-size: 0.9rem;
        }

        .positive { color: #27AE60; }
        .negative { color: #E74C3C; }
        .neutral { color: #F39C12; }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .comparison-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-weight: 600;
            color: #555;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .overall-charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üìä Enhanced Earnings Call Analytics Dashboard</h1>
            <p>Advanced sentiment analysis with sum calculations, primary industry support, and comparison features</p>
        </div>

        <div class="upload-area">
            <p>üìÅ Upload your CSV file (must include: company, quarter, primary_industry, and metric columns)</p>
            <input type="file" id="fileInput" accept=".csv" style="margin-top: 10px;">
        </div>

        <div class="controls" id="controls" style="display: none;">
            <div class="control-group">
                <label for="companySelect">Company:</label>
                <select id="companySelect">
                    <option value="all">All Companies</option>
                </select>
            </div>
            <div class="control-group">
                <label for="industrySelect">Primary Industry:</label>
                <select id="industrySelect">
                    <option value="all">All Industries</option>
                </select>
            </div>
            <div class="control-group">
                <label for="metricSelect">Primary Metric:</label>
                <select id="metricSelect">
                    <option value="question_LM_Positive">Question LM Positive</option>
                    <option value="question_LM_Negative">Question LM Negative</option>
                    <option value="question_LM_Polarity">Question LM Polarity</option>
                    <option value="question_LM_Subjectivity">Question LM Subjectivity</option>
                    <option value="question_HIV4_Positive">Question HIV4 Positive</option>
                    <option value="question_HIV4_Negative">Question HIV4 Negative</option>
                    <option value="question_HIV4_Polarity">Question HIV4 Polarity</option>
                    <option value="question_HIV4_Subjectivity">Question HIV4 Subjectivity</option>
                    <option value="answer_LM_Positive">Answer LM Positive</option>
                    <option value="answer_LM_Negative">Answer LM Negative</option>
                    <option value="answer_LM_Polarity">Answer LM Polarity</option>
                    <option value="answer_LM_Subjectivity">Answer LM Subjectivity</option>
                    <option value="answer_HIV4_Positive">Answer HIV4 Positive</option>
                    <option value="answer_HIV4_Negative">Answer HIV4 Negative</option>
                    <option value="answer_HIV4_Polarity">Answer HIV4 Polarity</option>
                    <option value="answer_HIV4_Subjectivity">Answer HIV4 Subjectivity</option>
                    <option value="question_Uncertainty">Question Uncertainty</option>
                    <option value="question_Litigious">Question Litigious</option>
                    <option value="question_Constraining">Question Constraining</option>
                    <option value="answer_Uncertainty">Answer Uncertainty</option>
                    <option value="answer_Litigious">Answer Litigious</option>
                    <option value="answer_Constraining">Answer Constraining</option>
                </select>
            </div>
            <div class="control-group">
                <label for="quarterRange">Quarter Range:</label>
                <select id="quarterRange">
                    <option value="all">All Quarters</option>
                    <option value="recent2">Recent 2 Quarters</option>
                    <option value="recent4">Recent 4 Quarters</option>
                    <option value="recent6">Recent 6 Quarters</option>
                    <option value="recent8">Recent 8 Quarters</option>
                </select>
            </div>
            <div class="control-group">
                <label for="compareSelect">Compare With:</label>
                <select id="compareSelect">
                    <option value="none">No Comparison</option>
                </select>
            </div>
            <div class="control-group">
                <button id="overallBtn" class="action-btn">üìä Overall View</button>
                <button id="industryCompareBtn" class="action-btn industry">üè≠ Industry Compare</button>
            </div>
        </div>

        <div id="comparisonInfo" class="comparison-info" style="display: none;"></div>

        <div id="summaryCards" class="summary-cards" style="display: none;"></div>

        <div id="chartsContainer" style="display: none;">
            <div class="chart-container" id="singleChartContainer">
                <h3 class="chart-title" id="chartTitle">üìà Time Series Analysis (Sum Values)</h3>
                <div class="chart-wrapper" id="chartWrapper">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
            
            <div id="overallChartsContainer" class="overall-charts" style="display: none;">
                <div class="overall-chart">
                    <h3 class="overall-chart-title">üìä Question Metrics (Sum)</h3>
                    <div class="overall-chart-wrapper">
                        <canvas id="questionChart"></canvas>
                    </div>
                </div>
                <div class="overall-chart">
                    <h3 class="overall-chart-title">üí¨ Answer Metrics (Sum)</h3>
                    <div class="overall-chart-wrapper">
                        <canvas id="answerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>Upload your CSV file to begin analysis...</p>
        </div>
    </div>

    <script>
        let globalData = [];
        let currentChart = null;
        let questionChart = null;
        let answerChart = null;
        let isOverallView = false;
        let isIndustryCompare = false;

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', handleFile);

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please upload a CSV file only.');
                return;
            }
            
            parseCSV(file);
        }

        function parseCSV(file) {
            document.getElementById('loading').innerHTML = '<p>üìä Processing your data...</p>';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        console.error('CSV parsing errors:', results.errors);
                    }
                    
                    globalData = results.data;
                    validateAndInitialize();
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    document.getElementById('loading').innerHTML = '<p>‚ùå Error parsing file. Please check your CSV format.</p>';
                }
            });
        }

        function parseQuarter(quarterStr) {
            // Handle various quarter formats and convert to "Q# YYYY" format
            if (!quarterStr) return { formatted: '', sortKey: '' };
            
            const str = quarterStr.toString().trim();
            
            // Match patterns like "Q1 2023", "2023 Q1", "2023Q1", "Q1-2023", etc.
            const patterns = [
                /^Q([1-4])\s*(\d{4})$/i,           // Q1 2023
                /^(\d{4})\s*Q([1-4])$/i,           // 2023 Q1
                /^(\d{4})Q([1-4])$/i,              // 2023Q1
                /^Q([1-4])-(\d{4})$/i,             // Q1-2023
                /^Q([1-4])_(\d{4})$/i,             // Q1_2023
                /^([1-4])Q(\d{4})$/i,              // 1Q2023
                /^(\d{4})-Q([1-4])$/i,             // 2023-Q1
                /^(\d{4})_Q([1-4])$/i              // 2023_Q1
            ];
            
            for (let pattern of patterns) {
                const match = str.match(pattern);
                if (match) {
                    let quarter, year;
                    
                    // Determine which group is quarter and which is year
                    if (match[1].length === 4) {
                        // First group is year
                        year = match[1];
                        quarter = match[2];
                    } else {
                        // First group is quarter
                        quarter = match[1];
                        year = match[2];
                    }
                    
                    const formatted = `Q${quarter} ${year}`;
                    const sortKey = `${year}Q${quarter}`;
                    
                    return { formatted, sortKey };
                }
            }
            
            // If no pattern matches, return original
            console.warn(`Could not parse quarter format: ${quarterStr}`);
            return { formatted: str, sortKey: str };
        }

        function validateAndInitialize() {
            if (globalData.length === 0) {
                document.getElementById('loading').innerHTML = '<p>‚ùå No data found in file.</p>';
                return;
            }

            // Check for required columns
            const requiredColumns = ['company', 'quarter'];
            const availableColumns = Object.keys(globalData[0] || {});
            const missingColumns = requiredColumns.filter(col => !availableColumns.includes(col));
            
            if (missingColumns.length > 0) {
                document.getElementById('loading').innerHTML = 
                    `<p>‚ùå Missing required columns: ${missingColumns.join(', ')}<br>
                    Available columns: ${availableColumns.join(', ')}</p>`;
                return;
            }

            // Check if primary_industry exists, if not create a default one
            if (!availableColumns.includes('primary_industry')) {
                console.log('primary_industry column not found, adding default values');
                globalData.forEach(row => {
                    row.primary_industry = 'General';
                });
            } else {
                console.log('primary_industry column found');
                // Clean up any null/undefined values in existing primary_industry column
                globalData.forEach(row => {
                    if (!row.primary_industry || row.primary_industry.toString().trim() === '') {
                        row.primary_industry = 'General';
                    }
                });
            }

            // Parse and format quarters
            globalData.forEach(row => {
                const parsedQuarter = parseQuarter(row.quarter);
                row.quarter_formatted = parsedQuarter.formatted;
                row.quarter_sort_key = parsedQuarter.sortKey;
            });
            
            console.log('Sample data after processing:', globalData.slice(0, 3)); // Debug log

            initializeDashboard();
        }

        function initializeDashboard() {
            // Show controls and charts
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('summaryCards').style.display = 'grid';
            document.getElementById('chartsContainer').style.display = 'block';
            document.getElementById('loading').style.display = 'none';

            // Populate dropdowns
            populateIndustryDropdown(); // Populate industry first
            populateCompanyDropdown();  // Then populate company based on industry
            populateCompareDropdown();
            
            // Set up event listeners
            document.getElementById('companySelect').addEventListener('change', () => {
                populateCompareDropdown();
                updateDashboard();
            });
            document.getElementById('industrySelect').addEventListener('change', () => {
                populateCompanyDropdown(); // Update company dropdown when industry changes
                populateCompareDropdown();
                updateDashboard();
            });
            document.getElementById('metricSelect').addEventListener('change', updateDashboard);
            document.getElementById('quarterRange').addEventListener('change', updateDashboard);
            document.getElementById('compareSelect').addEventListener('change', updateDashboard);
            document.getElementById('overallBtn').addEventListener('click', toggleOverallView);
            document.getElementById('industryCompareBtn').addEventListener('click', toggleIndustryCompare);

            // Initial dashboard update
            updateDashboard();
        }

        function populateCompanyDropdown() {
            const selectedIndustry = document.getElementById('industrySelect').value;
            let companies;
            
            if (selectedIndustry === 'all') {
                // Show all companies if "All Industries" is selected
                companies = [...new Set(globalData.map(row => row.company))].filter(Boolean).sort();
            } else {
                // Show only companies from the selected industry
                companies = [...new Set(globalData
                    .filter(row => row.primary_industry === selectedIndustry)
                    .map(row => row.company))]
                    .filter(Boolean)
                    .sort();
            }
            
            const select = document.getElementById('companySelect');
            const currentSelection = select.value;
            
            select.innerHTML = '<option value="all">All Companies</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                select.appendChild(option);
            });
            
            // Try to maintain the current selection if it's still valid
            if (currentSelection !== 'all' && companies.includes(currentSelection)) {
                select.value = currentSelection;
            } else {
                select.value = 'all';
            }
        }

        function populateIndustryDropdown() {
            // Get unique industry values, handling both null/undefined and actual values
            const industries = [...new Set(globalData.map(row => {
                // Handle cases where primary_industry might be null, undefined, or empty string
                const industry = row.primary_industry;
                return (industry && industry.toString().trim()) ? industry.toString().trim() : 'General';
            }))].filter(Boolean).sort();
            
            console.log('Available industries:', industries); // Debug log
            
            const select = document.getElementById('industrySelect');
            
            select.innerHTML = '<option value="all">All Industries</option>';
            
            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                select.appendChild(option);
            });
        }

        function populateCompareDropdown() {
            const selectedCompany = document.getElementById('companySelect').value;
            const selectedIndustry = document.getElementById('industrySelect').value;
            let companies;
            
            if (selectedIndustry === 'all') {
                // Show all companies if "All Industries" is selected
                companies = [...new Set(globalData.map(row => row.company))].filter(Boolean).sort();
            } else {
                // Show only companies from the selected industry
                companies = [...new Set(globalData
                    .filter(row => row.primary_industry === selectedIndustry)
                    .map(row => row.company))]
                    .filter(Boolean)
                    .sort();
            }
            
            const select = document.getElementById('compareSelect');
            
            select.innerHTML = '<option value="none">No Comparison</option>';
            
            companies.forEach(company => {
                if (company !== selectedCompany) {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = `vs ${company}`;
                    select.appendChild(option);
                }
            });
        }

        function toggleOverallView() {
            isOverallView = !isOverallView;
            const btn = document.getElementById('overallBtn');
            const singleContainer = document.getElementById('singleChartContainer');
            const overallContainer = document.getElementById('overallChartsContainer');
            
            if (isOverallView) {
                btn.textContent = 'üìà Single Metric';
                btn.classList.add('active');
                singleContainer.style.display = 'none';
                overallContainer.style.display = 'grid';
            } else {
                btn.textContent = 'üìä Overall View';
                btn.classList.remove('active');
                singleContainer.style.display = 'block';
                overallContainer.style.display = 'none';
            }
            
            updateDashboard();
        }

        function toggleIndustryCompare() {
            const selectedCompany = document.getElementById('companySelect').value;
            
            if (selectedCompany === 'all') {
                alert('Please select a specific company to compare with industry.');
                return;
            }

            isIndustryCompare = !isIndustryCompare;
            const btn = document.getElementById('industryCompareBtn');
            
            if (isIndustryCompare) {
                btn.textContent = 'üìä Single View';
                btn.classList.add('active');
            } else {
                btn.textContent = 'üè≠ Industry Compare';
                btn.classList.remove('active');
            }
            
            updateDashboard();
        }

        function updateDashboard() {
            const selectedCompany = document.getElementById('companySelect').value;
            const selectedIndustry = document.getElementById('industrySelect').value;
            const selectedMetric = document.getElementById('metricSelect').value;
            const quarterRange = document.getElementById('quarterRange').value;
            const compareWith = document.getElementById('compareSelect').value;

            // Filter data
            let filteredData = globalData;
            
            if (selectedCompany !== 'all') {
                filteredData = filteredData.filter(row => row.company === selectedCompany);
            }
            
            if (selectedIndustry !== 'all') {
                filteredData = filteredData.filter(row => row.primary_industry === selectedIndustry);
            }

            // Apply quarter filtering
            if (quarterRange !== 'all' && !isOverallView) {
                // Get unique quarters sorted by sort key
                const quarters = [...new Set(filteredData.map(row => ({ 
                    formatted: row.quarter_formatted, 
                    sortKey: row.quarter_sort_key 
                })))].sort((a, b) => a.sortKey.localeCompare(b.sortKey));
                
                const numQuarters = parseInt(quarterRange.replace('recent', ''));
                const recentQuarters = quarters.slice(-numQuarters).map(q => q.formatted);
                filteredData = filteredData.filter(row => recentQuarters.includes(row.quarter_formatted));
            }

            updateSummaryCards(filteredData);
            updateComparisonInfo(selectedCompany, compareWith, isIndustryCompare);
            
            if (isOverallView) {
                createOverallCharts(filteredData, compareWith);
            } else {
                createTimeSeriesChart(filteredData, selectedMetric, compareWith);
            }
        }

        function updateComparisonInfo(selectedCompany, compareWith, industryMode) {
            const infoDiv = document.getElementById('comparisonInfo');
            
            if (compareWith !== 'none' || industryMode) {
                let infoText = '';
                if (industryMode && selectedCompany !== 'all') {
                    const companyIndustry = globalData.find(row => row.company === selectedCompany)?.primary_industry;
                    infoText = `üè≠ Comparing ${selectedCompany} with ${companyIndustry} Industry Average`;
                } else if (compareWith !== 'none') {
                    infoText = `üîÑ Comparing ${selectedCompany} vs ${compareWith}`;
                }
                
                infoDiv.textContent = infoText;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        function updateSummaryCards(data) {
            const container = document.getElementById('summaryCards');
            
            const totalQuestions = data.length;
            
            // Calculate sum positive (LM + HIV4 combined)
            const sumPositive = data.reduce((sum, row) => {
                const lmPos = row.question_LM_Positive || 0;
                const hivPos = row.question_HIV4_Positive || 0;
                return sum + lmPos + hivPos;
            }, 0);

            // Calculate sum negative (LM + HIV4 combined)
            const sumNegative = data.reduce((sum, row) => {
                const lmNeg = row.question_LM_Negative || 0;
                const hivNeg = row.question_HIV4_Negative || 0;
                return sum + lmNeg + hivNeg;
            }, 0);
            
            const companies = new Set(data.map(row => row.company)).size;
            const industries = new Set(data.map(row => row.primary_industry)).size;

            container.innerHTML = `
                <div class="summary-card">
                    <h3>${totalQuestions}</h3>
                    <p>Total Questions</p>
                </div>
                <div class="summary-card">
                    <h3 class="positive">${sumPositive.toFixed(2)}</h3>
                    <p>Sum Positive (LM+HIV4)</p>
                </div>
                <div class="summary-card">
                    <h3 class="negative">${sumNegative.toFixed(2)}</h3>
                    <p>Sum Negative (LM+HIV4)</p>
                </div>
                <div class="summary-card">
                    <h3>${companies}</h3>
                    <p>Companies</p>
                </div>
                <div class="summary-card">
                    <h3>${industries}</h3>
                    <p>Industries</p>
                </div>
            `;
        }

        function createTimeSeriesChart(data, metric, compareWith) {
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }

            if (data.length === 0) {
                document.getElementById('timeSeriesChart').getContext('2d').clearRect(0, 0, 1000, 1000);
                return;
            }

            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            
            // Group data by quarter and calculate sums
            const quarterData = data.reduce((acc, row) => {
                const quarter = row.quarter_formatted;
                if (!acc[quarter]) acc[quarter] = [];
                acc[quarter].push(row);
                return acc;
            }, {});

            // Sort quarters by their sort keys
            const quarterEntries = Object.entries(quarterData);
            quarterEntries.sort((a, b) => {
                const aSortKey = data.find(row => row.quarter_formatted === a[0])?.quarter_sort_key || a[0];
                const bSortKey = data.find(row => row.quarter_formatted === b[0])?.quarter_sort_key || b[0];
                return aSortKey.localeCompare(bSortKey);
            });

            const quarters = quarterEntries.map(entry => entry[0]);
            const sortedQuarterData = Object.fromEntries(quarterEntries);

            const sumValues = quarters.map(quarter => {
                const values = sortedQuarterData[quarter].map(row => row[metric]).filter(val => val !== null && val !== undefined);
                return values.reduce((sum, val) => sum + val, 0);
            });

            const datasets = [{
                label: `${metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (Sum)`,
                data: sumValues,
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 12
            }];

            // Add comparison data
            if (compareWith !== 'none') {
                const compareData = globalData.filter(row => row.company === compareWith);
                const compareQuarterData = compareData.reduce((acc, row) => {
                    const quarter = row.quarter_formatted;
                    if (!acc[quarter]) acc[quarter] = [];
                    acc[quarter].push(row);
                    return acc;
                }, {});

                const compareSumValues = quarters.map(quarter => {
                    const values = (compareQuarterData[quarter] || []).map(row => row[metric]).filter(val => val !== null && val !== undefined);
                    return values.reduce((sum, val) => sum + val, 0);
                });

                datasets.push({
                    label: `${compareWith} - ${metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (Sum)`,
                    data: compareSumValues,
                    borderColor: 'rgba(231, 76, 60, 1)',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(231, 76, 60, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 10
                });
            }

            // Add industry comparison
            if (isIndustryCompare && data.length > 0) {
                const selectedCompany = document.getElementById('companySelect').value;
                const companyIndustry = globalData.find(row => row.company === selectedCompany)?.primary_industry;
                
                if (companyIndustry) {
                    // Get ALL companies in the same industry (including the selected company for industry total)
                    const industryData = globalData.filter(row => row.primary_industry === companyIndustry);
                    
                    const industryQuarterData = industryData.reduce((acc, row) => {
                        const quarter = row.quarter_formatted;
                        if (!acc[quarter]) acc[quarter] = [];
                        acc[quarter].push(row);
                        return acc;
                    }, {});

                    const industrySumValues = quarters.map(quarter => {
                        const values = (industryQuarterData[quarter] || []).map(row => row[metric]).filter(val => val !== null && val !== undefined);
                        return values.reduce((sum, val) => sum + val, 0);
                    });

                    datasets.push({
                        label: `${companyIndustry} Industry Total (Sum)`,
                        data: industrySumValues,
                        borderColor: 'rgba(243, 156, 18, 1)',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(243, 156, 18, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        borderDash: [5, 5]
                    });
                }
            }

            // Update chart title
            let titleText = `üìà Time Series Analysis - ${metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (Sum Values)`;
            document.getElementById('chartTitle').textContent = titleText;

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: quarters,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                },
                                maxRotation: 45
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createOverallCharts(data, compareWith) {
            // Destroy existing charts
            if (questionChart) {
                questionChart.destroy();
                questionChart = null;
            }
            if (answerChart) {
                answerChart.destroy();
                answerChart = null;
            }

            if (data.length === 0) return;

            // Question metrics
            const questionMetrics = [
                'question_LM_Positive', 'question_LM_Negative', 'question_LM_Polarity', 'question_LM_Subjectivity',
                'question_HIV4_Positive', 'question_HIV4_Negative', 'question_HIV4_Polarity', 'question_HIV4_Subjectivity',
                'question_Uncertainty', 'question_Litigious', 'question_Constraining'
            ];

            // Answer metrics
            const answerMetrics = [
                'answer_LM_Positive', 'answer_LM_Negative', 'answer_LM_Polarity', 'answer_LM_Subjectivity',
                'answer_HIV4_Positive', 'answer_HIV4_Negative', 'answer_HIV4_Polarity', 'answer_HIV4_Subjectivity',
                'answer_Uncertainty', 'answer_Litigious', 'answer_Constraining'
            ];

            // Group data by quarter and sort
            const quarterData = data.reduce((acc, row) => {
                const quarter = row.quarter_formatted;
                if (!acc[quarter]) acc[quarter] = [];
                acc[quarter].push(row);
                return acc;
            }, {});

            // Sort quarters by their sort keys
            const quarterEntries = Object.entries(quarterData);
            quarterEntries.sort((a, b) => {
                const aSortKey = data.find(row => row.quarter_formatted === a[0])?.quarter_sort_key || a[0];
                const bSortKey = data.find(row => row.quarter_formatted === b[0])?.quarter_sort_key || b[0];
                return aSortKey.localeCompare(bSortKey);
            });

            const quarters = quarterEntries.map(entry => entry[0]);
            const sortedQuarterData = Object.fromEntries(quarterEntries);

            // Create Question Chart
            const questionCtx = document.getElementById('questionChart').getContext('2d');
            const questionDatasets = questionMetrics.map((metric, index) => {
                const sumValues = quarters.map(quarter => {
                    const values = sortedQuarterData[quarter].map(row => row[metric]).filter(val => val !== null && val !== undefined);
                    return values.reduce((sum, val) => sum + val, 0);
                });

                const hue = (index * 360 / questionMetrics.length) % 360;
                return {
                    label: metric.replace(/question_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: sumValues,
                    borderColor: `hsl(${hue}, 70%, 50%)`,
                    backgroundColor: `hsla(${hue}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6
                };
            });

            // Add comparison datasets for questions if needed
            if (compareWith !== 'none') {
                const compareData = globalData.filter(row => row.company === compareWith);
                const compareQuarterData = compareData.reduce((acc, row) => {
                    const quarter = row.quarter_formatted;
                    if (!acc[quarter]) acc[quarter] = [];
                    acc[quarter].push(row);
                    return acc;
                }, {});

                questionMetrics.forEach((metric, index) => {
                    const compareSumValues = quarters.map(quarter => {
                        const values = (compareQuarterData[quarter] || []).map(row => row[metric]).filter(val => val !== null && val !== undefined);
                        return values.reduce((sum, val) => sum + val, 0);
                    });

                    const hue = (index * 360 / questionMetrics.length) % 360;
                    questionDatasets.push({
                        label: `${compareWith} - ${metric.replace(/question_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                        data: compareSumValues,
                        borderColor: `hsl(${hue}, 70%, 30%)`,
                        backgroundColor: `hsla(${hue}, 70%, 30%, 0.1)`,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        borderDash: [3, 3]
                    });
                });
            }

            // Add industry comparison for questions
            if (isIndustryCompare && data.length > 0) {
                const selectedCompany = document.getElementById('companySelect').value;
                const companyIndustry = globalData.find(row => row.company === selectedCompany)?.primary_industry;
                
                if (companyIndustry) {
                    questionMetrics.forEach((metric, index) => {
                        const industrySumValues = quarters.map(quarter => {
                            // Get ALL companies in the industry for this quarter
                            const allIndustryCompaniesThisQuarter = globalData.filter(row => 
                                row.primary_industry === companyIndustry && row.quarter_formatted === quarter
                            );
                            const values = allIndustryCompaniesThisQuarter.map(row => row[metric]).filter(val => val !== null && val !== undefined);
                            return values.reduce((sum, val) => sum + val, 0);
                        });

                        const hue = (index * 360 / questionMetrics.length) % 360;
                        questionDatasets.push({
                            label: `${companyIndustry} Industry - ${metric.replace(/question_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                            data: industrySumValues,
                            borderColor: `hsl(${hue}, 50%, 40%)`,
                            backgroundColor: `hsla(${hue}, 50%, 40%, 0.1)`,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    });
                }
            }

            questionChart = new Chart(questionCtx, {
                type: 'line',
                data: {
                    labels: quarters,
                    datasets: questionDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 8
                                },
                                boxWidth: 8,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // Create Answer Chart
            const answerCtx = document.getElementById('answerChart').getContext('2d');
            const answerDatasets = answerMetrics.map((metric, index) => {
                const sumValues = quarters.map(quarter => {
                    const values = sortedQuarterData[quarter].map(row => row[metric]).filter(val => val !== null && val !== undefined);
                    return values.reduce((sum, val) => sum + val, 0);
                });

                const hue = (index * 360 / answerMetrics.length) % 360;
                return {
                    label: metric.replace(/answer_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: sumValues,
                    borderColor: `hsl(${hue}, 70%, 50%)`,
                    backgroundColor: `hsla(${hue}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6
                };
            });

            // Add comparison datasets for answers if needed
            if (compareWith !== 'none') {
                const compareData = globalData.filter(row => row.company === compareWith);
                const compareQuarterData = compareData.reduce((acc, row) => {
                    const quarter = row.quarter_formatted;
                    if (!acc[quarter]) acc[quarter] = [];
                    acc[quarter].push(row);
                    return acc;
                }, {});

                answerMetrics.forEach((metric, index) => {
                    const compareSumValues = quarters.map(quarter => {
                        const values = (compareQuarterData[quarter] || []).map(row => row[metric]).filter(val => val !== null && val !== undefined);
                        return values.reduce((sum, val) => sum + val, 0);
                    });

                    const hue = (index * 360 / answerMetrics.length) % 360;
                    answerDatasets.push({
                        label: `${compareWith} - ${metric.replace(/answer_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                        data: compareSumValues,
                        borderColor: `hsl(${hue}, 70%, 30%)`,
                        backgroundColor: `hsla(${hue}, 70%, 30%, 0.1)`,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        borderDash: [3, 3]
                    });
                });
            }

            // Add industry comparison for answers
            if (isIndustryCompare && data.length > 0) {
                const selectedCompany = document.getElementById('companySelect').value;
                const companyIndustry = globalData.find(row => row.company === selectedCompany)?.primary_industry;
                
                if (companyIndustry) {
                    answerMetrics.forEach((metric, index) => {
                        const industrySumValues = quarters.map(quarter => {
                            // Get ALL companies in the industry for this quarter
                            const allIndustryCompaniesThisQuarter = globalData.filter(row => 
                                row.primary_industry === companyIndustry && row.quarter_formatted === quarter
                            );
                            const values = allIndustryCompaniesThisQuarter.map(row => row[metric]).filter(val => val !== null && val !== undefined);
                            return values.reduce((sum, val) => sum + val, 0);
                        });

                        const hue = (index * 360 / answerMetrics.length) % 360;
                        answerDatasets.push({
                            label: `${companyIndustry} Industry - ${metric.replace(/answer_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                            data: industrySumValues,
                            borderColor: `hsl(${hue}, 50%, 40%)`,
                            backgroundColor: `hsla(${hue}, 50%, 40%, 0.1)`,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    });
                }
            }

            answerChart = new Chart(answerCtx, {
                type: 'line',
                data: {
                    labels: quarters,
                    datasets: answerDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 8
                                },
                                boxWidth: 8,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
    </script>
</body>
</html>
